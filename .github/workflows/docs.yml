name: CodeBoarding Documentation (Direct)

on:
  workflow_dispatch:
    inputs:
      repository_url:
        description: 'Repository URL to analyze (defaults to current repo)'
        required: false
        default: ''
        type: string
      source_branch:
        description: 'Source branch to analyze'
        required: false
        default: ''
        type: string
      target_branch:
        description: 'Target branch for documentation'
        required: false
        default: ''
        type: string
      output_directory:
        description: 'Output directory for documentation files'
        required: false
        default: '.codeboarding'
        type: string
      output_format:
        description: 'Output format for documentation'
        required: false
        default: '.md'
        type: choice
        options:
          - '.md'
          - '.mdx'
          - '.rst'
  push:
    branches:
      - master
      - main

jobs:
  update-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout CodeBoarding engine
        uses: actions/checkout@v4
        with:
          repository: CodeBoarding/CodeBoarding
          path: codeboarding-engine
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          path: target-repo

      - name: Set branch variables
        id: set-branches
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "source_branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "target_branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "repository_url=https://github.com/${{ github.repository }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.source_branch }}" != "" ] && [ "${{ github.event.inputs.target_branch }}" != "" ]; then
            echo "source_branch=${{ github.event.inputs.source_branch }}" >> $GITHUB_OUTPUT
            echo "target_branch=${{ github.event.inputs.target_branch }}" >> $GITHUB_OUTPUT
            echo "repository_url=${{ github.event.inputs.repository_url || format('https://github.com/{0}', github.repository) }}" >> $GITHUB_OUTPUT
          else
            echo "source_branch=main" >> $GITHUB_OUTPUT
            echo "target_branch=main" >> $GITHUB_OUTPUT
            echo "repository_url=https://github.com/${{ github.repository }}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Cache uv venv
        uses: actions/cache@v4
        with:
          path: codeboarding-engine/.venv
          key: uv-venv-${{ runner.os }}-${{ hashFiles('codeboarding-engine/pyproject.toml', 'codeboarding-engine/uv.lock') }}
          restore-keys: |
            uv-venv-${{ runner.os }}-

      - name: Cache LSP servers and binaries
        uses: actions/cache@v4
        with:
          path: |
            codeboarding-engine/static_analyzer/servers/node_modules
            codeboarding-engine/static_analyzer/servers/bin
          key: lsp-servers-${{ runner.os }}-v1
          restore-keys: |
            lsp-servers-${{ runner.os }}-

      - name: Install Python dependencies
        working-directory: codeboarding-engine
        run: |
          uv venv --clear
          uv pip install -e .

      - name: Install LSP servers and binaries
        working-directory: codeboarding-engine
        run: |
          uv run python install.py --auto-install-npm

      - name: Run CodeBoarding analysis
        working-directory: codeboarding-engine
        timeout-minutes: 30
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          VERCEL_API_KEY: ${{ secrets.VERCEL_API_KEY }}
          REPO_ROOT: ${{ github.workspace }}/codeboarding-engine/repos
          STATIC_ANALYSIS_CONFIG: ${{ github.workspace }}/codeboarding-engine/static_analysis_config.yml
          PROJECT_ROOT: ${{ github.workspace }}/codeboarding-engine
          DIAGRAM_DEPTH_LEVEL: '5'
          CACHING_DOCUMENTATION: 'false'
          ENABLE_MONITORING: 'false'
        run: |
          # Ensure repos directory exists
          mkdir -p repos

          OUTPUT_FORMAT="${{ github.event.inputs.output_format || '.md' }}"
          OUTPUT_DIR="${{ github.event.inputs.output_directory || '.codeboarding' }}"
          REPO_URL="${{ steps.set-branches.outputs.repository_url }}"
          SOURCE_BRANCH="${{ steps.set-branches.outputs.source_branch }}"
          TARGET_BRANCH="${{ steps.set-branches.outputs.target_branch }}"

          echo "Generating docs for: $REPO_URL"
          echo "Source branch: $SOURCE_BRANCH"
          echo "Target branch: $TARGET_BRANCH"
          echo "Output format: $OUTPUT_FORMAT"
          echo "Output directory: $OUTPUT_DIR"

          uv run python -c "
          from github_action import generate_analysis
          result_dir = generate_analysis(
              repo_url='$REPO_URL',
              source_branch='$SOURCE_BRANCH',
              target_branch='$TARGET_BRANCH',
              extension='$OUTPUT_FORMAT',
              output_dir='$OUTPUT_DIR',
          )
          print(f'Generated files in: {result_dir}')
          "

      - name: Copy generated files to target repo
        id: copy-files
        run: |
          OUTPUT_DIR="${{ github.event.inputs.output_directory || '.codeboarding' }}"
          OUTPUT_FORMAT="${{ github.event.inputs.output_format || '.md' }}"
          ENGINE_TEMP=$(find codeboarding-engine/temp -maxdepth 1 -mindepth 1 -type d | head -1)

          if [ -z "$ENGINE_TEMP" ]; then
            echo "No temp directory found - analysis may have failed"
            exit 1
          fi

          echo "Found generated files in: $ENGINE_TEMP"
          ls -la "$ENGINE_TEMP"

          # Copy doc files to target repo output directory
          mkdir -p "target-repo/$OUTPUT_DIR"

          json_count=0
          doc_count=0

          for f in "$ENGINE_TEMP"/*.json; do
            if [ -f "$f" ]; then
              cp "$f" "target-repo/$OUTPUT_DIR/"
              json_count=$((json_count + 1))
            fi
          done

          for f in "$ENGINE_TEMP"/*"$OUTPUT_FORMAT"; do
            if [ -f "$f" ]; then
              cp "$f" "target-repo/$OUTPUT_DIR/"
              doc_count=$((doc_count + 1))
            fi
          done

          echo "Copied $json_count JSON files and $doc_count doc files to target-repo/$OUTPUT_DIR/"
          echo "json_files_created=$json_count" >> $GITHUB_OUTPUT
          echo "markdown_files_created=$doc_count" >> $GITHUB_OUTPUT
          echo "output_directory=$OUTPUT_DIR" >> $GITHUB_OUTPUT

      - name: Check for changes in target repo
        id: git-changes
        working-directory: target-repo
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_git_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_git_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate architecture documentation
        if: steps.git-changes.outputs.has_git_changes == 'true'
        working-directory: target-repo
        run: |
          OUTPUT_DIR="${{ github.event.inputs.output_directory || '.codeboarding' }}"
          output_format="${{ github.event.inputs.output_format || '.md' }}"
          file_extension="${output_format}"

          mkdir -p docs/development
          echo "" > "docs/development/architecture${file_extension}"

          if [ -f "${OUTPUT_DIR}/on_boarding${file_extension}" ]; then
            echo "Found and adding: on_boarding${file_extension}"
            cat "${OUTPUT_DIR}/on_boarding${file_extension}" > "docs/development/architecture${file_extension}"
            echo "" >> "docs/development/architecture${file_extension}"
          fi

          for file in ${OUTPUT_DIR}/*${file_extension}; do
            if [ -f "$file" ] && [ "$(basename "$file")" != "on_boarding${file_extension}" ]; then
              filename=$(basename "$file")
              echo "Found and adding: $filename"
              echo "" >> "docs/development/architecture${file_extension}"
              cat "$file" >> "docs/development/architecture${file_extension}"
              echo "" >> "docs/development/architecture${file_extension}"
            fi
          done

      - name: Commit and push changes
        if: steps.git-changes.outputs.has_git_changes == 'true'
        working-directory: target-repo
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "docs: update codeboarding documentation

          Documentation files created/updated: ${{ steps.copy-files.outputs.markdown_files_created }}
          JSON files created/updated: ${{ steps.copy-files.outputs.json_files_created }}
          Output format: ${{ github.event.inputs.output_format || '.md' }}
          Repository analyzed: ${{ steps.set-branches.outputs.repository_url }}

          Generated directly in GitHub Actions (no external server).
          "
          git push
